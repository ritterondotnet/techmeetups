)]}'
{"version":3,"sources":["useraccounts:iron-routing/lib/core.js","useraccounts:iron-routing/lib/client.js","useraccounts:iron-routing/lib/templates_helpers/at_input.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,S;AACA,0B;AACA,E;AACA,a;;AAEA,oF;;AAEA,mC;;AAEA,oF;;AAEA,uD;AACA,iB;AACA,+B;AACA,+B;AACA,mC;AACA,yC;AACA,2E;AACA,E;;AAEA,E;AACA,0G;AACA,kG;AACA,wF;AACA,wF;AACA,8E;AACA,wE;AACA,8G;AACA,E;;;AAGA,gE;AACA,mC;AACA,wE;AACA,uE;AACA,0D;AACA,wE;AACA,uE;AACA,gE;AACA,gE;AACA,qE;AACA,qF;AACA,E;;;AAGA,+B;AACA,Y;AACA,8C;AACA,8D;;AAEA,iE;AACA,mC;;AAEA,oB;AACA,8B;;AAEA,6D;AACA,uB;AACA,2E;AACA,6B;AACA,+D;AACA,0B;AACA,2F;AACA,G;AACA,0C;AACA,uC;AACA,sC;AACA,G;AACA,wC;AACA,6B;AACA,iD;AACA,G;;AAEA,mD;AACA,2D;AACA,sC;AACA,G;AACA,sC;AACA,iE;;AAEA,+B;AACA,uE;AACA,mD;;AAEA,uB;AACA,6C;AACA,8B;AACA,gD;AACA,oD;AACA,8D;AACA,Q;AACA,K;AACA,6C;AACA,mC;AACA,qD;AACA,oD;AACA,mE;AACA,Q;AACA,K;AACA,2C;AACA,iC;AACA,mD;AACA,kD;AACA,iE;AACA,Q;AACA,K;AACA,G;;AAEA,mC;AACA,W;AACA,G;AACA,iF;AACA,yF;AACA,G;AACA,mF;AACA,2F;AACA,G;AACA,oF;AACA,4F;AACA,G;;AAEA,oG;AACA,+F;;AAEA,iD;AACA,iD;AACA,sD;AACA,+D;AACA,2C;AACA,4D;AACA,K;;AAEA,kC;AACA,uE;AACA,2B;AACA,kC;AACA,sD;AACA,mB;AACA,2B;AACA,uC;AACA,2B;AACA,4C;AACA,8C;AACA,6C;AACA,sD;AACA,iD;AACA,sE;AACA,qG;AACA,e;AACA,a;;AAEA,sB;AACA,U;AACA,4B;AACA,yC;AACA,U;AACA,U;AACA,K;AACA,U;AACA,sD;AACA,mB;AACA,2B;AACA,uC;AACA,oC;AACA,gE;AACA,4C;AACA,sB;AACA,U;AACA,4B;AACA,yC;AACA,8C;AACA,S;AACA,U;AACA,K;AACA,G;AACA,Q;AACA,oD;AACA,iB;AACA,yB;AACA,qC;AACA,kC;AACA,6B;AACA,oC;AACA,wD;AACA,4B;AACA,W;AACA,S;AACA,mC;AACA,0B;AACA,S;AACA,uB;AACA,sD;AACA,sB;AACA,S;AACA,c;AACA,4C;AACA,sB;AACA,S;AACA,Q;AACA,0B;AACA,uC;AACA,O;AACA,Q;AACA,G;AACA,E;;;AAGA,kD;AACA,6B;AACA,mC;AACA,G;AACA,c;AACA,E;;AAEA,kD;AACA,6B;AACA,mC;AACA,G;AACA,a;AACA,E;;;;;;;;;;;;;;;;;;;AC3NA,S;AACA,2B;AACA,oB;AACA,c;AACA,e;AACA,E;AACA,a;;;AAGA,oD;AACA,mC;;AAEA,oE;AACA,qB;AACA,0C;;;AAGA,2C;AACA,uC;AACA,wB;AACA,K;AACA,6B;AACA,0B;AACA,2B;AACA,4B;;AAEA,uC;;AAEA,wC;AACA,oD;AACA,4D;AACA,8C;AACA,G;AACA,E;;AAEA,mC;AACA,4C;AACA,0B;AACA,E;;AAEA,mC;AACA,mD;AACA,2B;AACA,6B;AACA,E;;AAEA,iC;AACA,yB;AACA,qC;AACA,0D;AACA,O;AACA,kF;AACA,8D;AACA,uD;AACA,O;AACA,2C;AACA,yE;;AAEA,0D;;AAEA,uG;AACA,0G;AACA,4F;;AAEA,iG;AACA,iG;AACA,8E;;AAEA,gC;AACA,0B;AACA,yB;AACA,U;AACA,mC;AACA,gB;AACA,G;AACA,E;;AAEA,+C;AACA,e;AACA,gH;AACA,4G;AACA,I;AACA,4B;AACA,E;;;AAGA,iE;AACA,4D;AACA,0B;AACA,6B;AACA,6B;AACA,Y;AACA,oB;AACA,K;AACA,c;;AAEA,wB;AACA,mB;AACA,W;AACA,I;;AAEA,2B;AACA,mC;AACA,K;AACA,E;;;;AAIA,yC;AACA,0B;AACA,mC;AACA,2C;AACA,iE;AACA,2E;AACA,kB;AACA,qB;AACA,O;AACA,4C;AACA,sD;AACA,mB;AACA,O;AACA,gC;AACA,iD;AACA,K;AACA,4C;AACA,K;AACA,G;;;AAGA,8C;AACA,qC;AACA,W;AACA,G;AACA,mD;AACA,kG;AACA,sC;AACA,G;AACA,Q;AACA,4B;AACA,sB;AACA,O;AACA,G;;AAEA,+D;AACA,wC;AACA,K;AACA,0B;AACA,yD;AACA,G;AACA,E;;AAEA,sC;AACA,4D;AACA,8D;AACA,2B;AACA,uB;AACA,qB;AACA,K;AACA,6B;AACA,+B;AACA,K;AACA,K;AACA,E;;AAEA,uD;AACA,wC;AACA,4C;AACA,G;AACA,Q;AACA,+F;AACA,kB;AACA,mC;AACA,mB;AACA,O;AACA,Y;AACA,4B;AACA,O;AACA,U;AACA,yD;AACA,2E;AACA,gC;AACA,O;AACA,W;AACA,oE;AACA,4B;AACA,mC;AACA,S;AACA,O;AACA,K;AACA,G;AACA,E;;AAEA,qE;;AAEA,4D;AACA,oB;AACA,+B;AACA,G;;AAEA,c;AACA,mC;AACA,+E;AACA,qD;AACA,8D;AACA,S;AACA,K;AACA,U;AACA,+C;AACA,yB;AACA,2B;AACA,O;AACA,uD;AACA,sC;AACA,O;AACA,uD;AACA,K;AACA,yC;AACA,qC;AACA,wE;AACA,yB;AACA,K;AACA,G;AACA,O;AACA,oB;AACA,kB;AACA,K;;AAEA,sF;AACA,sE;AACA,gC;AACA,0E;AACA,oD;AACA,+C;AACA,sD;AACA,4B;AACA,O;AACA,K;AACA,oB;AACA,2C;AACA,kD;AACA,K;AACA,G;AACA,E;;;;;;;;;;;;;;;;;;;AClPA,S;AACA,2B;AACA,e;AACA,E;AACA,a;;AAEA,+C;AACA,8B;AACA,4E;AACA,kC;AACA,8G;AACA,sB;AACA,2D;AACA,G;;AAEA,0C;AACA,+E;;AAEA,kD;AACA,8E;AACA,0C;AACA,O;;AAEA,iE;AACA,kD;AACA,K;AACA,G;AACA,E","file":"/packages/useraccounts_iron-routing.js","sourcesContent":["/* global\n  AccountsTemplates: false\n*/\n'use strict';\n\n// ---------------------------------------------------------------------------------\n\n// Patterns for methods\" parameters\n\n// ---------------------------------------------------------------------------------\n\n// Route configuration pattern to be checked with check\nvar ROUTE_PAT = {\n  name: Match.Optional(String),\n  path: Match.Optional(String),\n  template: Match.Optional(String),\n  layoutTemplate: Match.Optional(String),\n  redirect: Match.Optional(Match.OneOf(String, Match.Where(_.isFunction))),\n};\n\n/*\n  Routes configuration can be done by calling AccountsTemplates.configureRoute with the route name and the\n  following options in a separate object. E.g. AccountsTemplates.configureRoute(\"gingIn\", option);\n    name:           String (optional). A unique route\"s name to be passed to iron-router\n    path:           String (optional). A unique route\"s path to be passed to iron-router\n    template:       String (optional). The name of the template to be rendered\n    layoutTemplate: String (optional). The name of the layout to be used\n    redirect:       String (optional). The name of the route (or its path) where to redirect after form submit\n*/\n\n\n// Allowed routes along with theirs default configuration values\nAccountsTemplates.ROUTE_DEFAULT = {\n  changePwd:      { name: \"atChangePwd\",      path: \"/change-password\"},\n  enrollAccount:  { name: \"atEnrollAccount\",  path: \"/enroll-account\"},\n  ensureSignedIn: { name: \"atEnsureSignedIn\", path: null},\n  forgotPwd:      { name: \"atForgotPwd\",      path: \"/forgot-password\"},\n  resetPwd:       { name: \"atResetPwd\",       path: \"/reset-password\"},\n  signIn:         { name: \"atSignIn\",         path: \"/sign-in\"},\n  signUp:         { name: \"atSignUp\",         path: \"/sign-up\"},\n  verifyEmail:    { name: \"atVerifyEmail\",    path: \"/verify-email\"},\n  resendVerificationEmail: { name: \"atResendVerificationEmail\", path: \"/send-again\"},\n};\n\n\n// Current configuration values\n// Redirects\nAccountsTemplates.options.homeRoutePath = \"/\";\nAccountsTemplates.options.redirectTimeout = 2000; // 2 seconds\n\n// Known routes used to filter out previous path for redirects...\nAccountsTemplates.knownRoutes = [];\n\n// Configured routes\nAccountsTemplates.routes = {};\n\nAccountsTemplates.configureRoute = function(route, options) {\n  check(route, String);\n  check(options, Match.OneOf(undefined, Match.ObjectIncluding(ROUTE_PAT)));\n  options = _.clone(options);\n  // Route Configuration can be done only before initialization\n  if (this._initialized) {\n    throw new Error(\"Route Configuration can be done only before AccountsTemplates.init!\");\n  }\n  // Only allowed routes can be configured\n  if (!(route in this.ROUTE_DEFAULT)) {\n    throw new Error(\"Unknown Route!\");\n  }\n  // Allow route configuration only once\n  if (route in this.routes) {\n    throw new Error(\"Route already configured!\");\n  }\n\n  // Possibly adds a initial / to the provided path\n  if (options && options.path && options.path[0] !== \"/\") {\n    options.path = \"/\" + options.path;\n  }\n  // Updates the current configuration\n  options = _.defaults(options || {}, this.ROUTE_DEFAULT[route]);\n\n  this.routes[route] = options;\n  // Known routes are used to filter out previous path for redirects...\n  AccountsTemplates.knownRoutes.push(options.path);\n\n  if (Meteor.isServer){\n    // Configures \"reset password\" email link\n    if (route === \"resetPwd\"){\n      var resetPwdPath = options.path.substr(1);\n      Accounts.urls.resetPassword = function(token){\n        return Meteor.absoluteUrl(resetPwdPath + \"/\" + token);\n      };\n    }\n    // Configures \"enroll account\" email link\n    if (route === \"enrollAccount\"){\n      var enrollAccountPath = options.path.substr(1);\n      Accounts.urls.enrollAccount = function(token){\n        return Meteor.absoluteUrl(enrollAccountPath + \"/\" + token);\n      };\n    }\n    // Configures \"verify email\" email link\n    if (route === \"verifyEmail\"){\n      var verifyEmailPath = options.path.substr(1);\n      Accounts.urls.verifyEmail = function(token){\n        return Meteor.absoluteUrl(verifyEmailPath + \"/\" + token);\n      };\n    }\n  }\n\n  if (route === \"ensureSignedIn\") {\n    return;\n  }\n  if (route === \"changePwd\" && !AccountsTemplates.options.enablePasswordChange) {\n    throw new Error(\"changePwd route configured but enablePasswordChange set to false!\");\n  }\n  if (route === \"forgotPwd\" && !AccountsTemplates.options.showForgotPasswordLink) {\n    throw new Error(\"forgotPwd route configured but showForgotPasswordLink set to false!\");\n  }\n  if (route === \"signUp\" && AccountsTemplates.options.forbidClientAccountCreation) {\n    throw new Error(\"signUp route configured but forbidClientAccountCreation set to true!\");\n  }\n\n  // Determines the default layout to be used in case no specific one is specified for single routes\n  var defaultLayout = AccountsTemplates.options.defaultLayout || Router.options.layoutTemplate;\n\n  var name = options.name; // Default provided...\n  var path = options.path; // Default provided...\n  var template = options.template || \"fullPageAtForm\";\n  var layoutTemplate = options.layoutTemplate || defaultLayout;\n  var additionalOptions = _.omit(options, [\n    \"layoutTemplate\", \"name\", \"path\", \"redirect\", \"template\"\n  ]);\n\n  // Possibly adds token parameter\n  if (_.contains([\"enrollAccount\", \"resetPwd\", \"verifyEmail\"], route)){\n    path += \"/:paramToken\";\n    if (route === \"verifyEmail\") {\n      Router.route(path, _.extend(additionalOptions, {\n        name: name,\n        template: template,\n        layoutTemplate: layoutTemplate,\n        onRun: function() {\n          AccountsTemplates.setState(route);\n          AccountsTemplates.setDisabled(true);\n          var token = this.params.paramToken;\n          Accounts.verifyEmail(token, function(error){\n            AccountsTemplates.setDisabled(false);\n            AccountsTemplates.submitCallback(error, route, function(){\n              AccountsTemplates.state.form.set(\"result\", AccountsTemplates.texts.info.emailVerified);\n            });\n          });\n\n          this.next();\n        },\n        onStop: function() {\n          AccountsTemplates.clearState();\n        },\n      }));\n    }\n    else {\n      Router.route(path, _.extend(additionalOptions, {\n        name: name,\n        template: template,\n        layoutTemplate: layoutTemplate,\n        onBeforeAction: function() {\n          AccountsTemplates.paramToken = this.params.paramToken;\n          AccountsTemplates.setState(route);\n          this.next();\n        },\n        onStop: function() {\n          AccountsTemplates.clearState();\n          AccountsTemplates.paramToken = null;\n        }\n      }));\n    }\n  }\n  else {\n    Router.route(path, _.extend(additionalOptions, {\n      name: name,\n      template: template,\n      layoutTemplate: layoutTemplate,\n      onBeforeAction: function() {\n        var redirect = false;\n        if (route === 'changePwd') {\n          if (!Meteor.loggingIn() && !Meteor.userId()) {\n            redirect = true;\n          }\n        }\n        else if (Meteor.userId()) {\n          redirect = true;\n        }\n        if (redirect) {\n          AccountsTemplates.postSubmitRedirect(route);\n          this.stop();\n        }\n        else {\n          AccountsTemplates.setState(route);\n          this.next();\n        }\n      },\n      onStop: function() {\n        AccountsTemplates.clearState();\n      }\n    }));\n  }\n};\n\n\nAccountsTemplates.getRouteName = function(route) {\n  if (route in this.routes) {\n    return this.routes[route].name;\n  }\n  return null;\n};\n\nAccountsTemplates.getRoutePath = function(route) {\n  if (route in this.routes) {\n    return this.routes[route].path;\n  }\n  return \"#\";\n};\n","/* global\n  AccountsTemplates: false,\n  grecaptcha: false,\n  Iron: false,\n  Router: false\n*/\n'use strict';\n\n\n// Previous path used for redirect after form submit\nAccountsTemplates._prevPath = null;\n\n// Possibly keeps reference to the handle for the timed out redirect\n// set on some routes\nAccountsTemplates.timedOutRedirect = null;\n\n\nAccountsTemplates.clearState = function() {\n  _.each(this._fields, function(field){\n    field.clearStatus();\n  });\n  var form = this.state.form;\n  form.set('error', null);\n  form.set('result', null);\n  form.set('message', null);\n\n  AccountsTemplates.setDisabled(false);\n\n  // Possibly clears timed out redirects\n  if (AccountsTemplates.timedOutRedirect !== null) {\n    Meteor.clearTimeout(AccountsTemplates.timedOutRedirect);\n    AccountsTemplates.timedOutRedirect = null;\n  }\n};\n\n// Getter for previous route's path\nAccountsTemplates.getPrevPath = function() {\n    return this._prevPath;\n};\n\n// Setter for previous route's path\nAccountsTemplates.setPrevPath = function(newPath) {\n    check(newPath, String);\n    this._prevPath = newPath;\n};\n\nvar ensureSignedIn = function() {\n  if (!Meteor.userId()) {\n    Tracker.nonreactive(function () {\n      AccountsTemplates.setPrevPath(Router.current().url);\n    });\n    AccountsTemplates.setState(AccountsTemplates.options.defaultState, function(){\n      var err = AccountsTemplates.texts.errors.mustBeLoggedIn;\n      AccountsTemplates.state.form.set('error', [err]);\n    });\n    AccountsTemplates.avoidRedirect = true;\n    // render the login template but keep the url in the browser the same\n\n    var options = AccountsTemplates.routes.ensureSignedIn;\n\n    // Determines the template to be rendered in case no specific one was configured for ensureSignedIn\n    var signInRouteTemplate = AccountsTemplates.routes.signIn && AccountsTemplates.routes.signIn.template;\n    var template = (options && options.template) || signInRouteTemplate || 'fullPageAtForm';\n\n    // Determines the layout to be used in case no specific one was configured for ensureSignedIn\n    var defaultLayout = AccountsTemplates.options.defaultLayout || Router.options.layoutTemplate;\n    var layoutTemplate = (options && options.layoutTemplate) || defaultLayout;\n\n    this.layout(layoutTemplate);\n    this.render(template);\n    this.renderRegions();\n  } else {\n    AccountsTemplates.clearError();\n    this.next();\n  }\n};\n\nAccountsTemplates.ensureSignedIn = function() {\n  console.warn(\n    '[UserAccounts] AccountsTemplates.ensureSignedIn will be deprecated soon, please use the plugin version\\n' +\n    '               see https://github.com/meteor-useraccounts/core/blob/master/Guide.md#content-protection'\n  );\n  ensureSignedIn.call(this);\n};\n\n\nIron.Router.plugins.ensureSignedIn = function (router, options) {\n  // this loading plugin just creates an onBeforeAction hook\n  router.onRun(function(){\n    if (Meteor.loggingIn()) {\n        this.renderRegions();\n    } else {\n        this.next();\n    }\n  }, options);\n\n  router.onBeforeAction(\n    ensureSignedIn,\n    options\n  );\n\n  router.onStop(function(){\n    AccountsTemplates.clearError();\n  });\n};\n\n\n\n// Stores previous path on path change...\nRouter.onStop(function() {\n  Tracker.nonreactive(function () {\n    var currentPath = Router.current().url;\n    var currentPathClean = currentPath.replace(/^\\/+|\\/+$/gm,'');\n    var isKnownRoute = _.map(AccountsTemplates.knownRoutes, function(path){\n      if (!path) {\n        return false;\n      }\n      path = path.replace(/^\\/+|\\/+$/gm,'');\n      var known = RegExp(path).test(currentPathClean);\n      return known;\n    });\n    if (!_.some(isKnownRoute)) {\n      AccountsTemplates.setPrevPath(currentPath);\n    }\n    AccountsTemplates.avoidRedirect = false;\n  });\n});\n\n\nAccountsTemplates.linkClick = function(route){\n  if (AccountsTemplates.disabled()) {\n    return;\n  }\n  var path = AccountsTemplates.getRoutePath(route);\n  if (path === '#' || AccountsTemplates.avoidRedirect || path === Router.current().route.path()) {\n    AccountsTemplates.setState(route);\n  }\n  else {\n    Meteor.defer(function(){\n      Router.go(path);\n    });\n  }\n\n  var firstVisibleInput = _.find(this.getFields(), function(f){\n    return _.contains(f.visible, route);\n  });\n  if (firstVisibleInput) {\n    $('input#at-field-' + firstVisibleInput._id).focus();\n  }\n};\n\nAccountsTemplates.logout = function(){\n  var onLogoutHook = AccountsTemplates.options.onLogoutHook;\n  var homeRoutePath = AccountsTemplates.options.homeRoutePath;\n  Meteor.logout(function(){\n    if (onLogoutHook) {\n      onLogoutHook();\n    }\n    else if (homeRoutePath) {\n      Router.go(homeRoutePath);\n    }\n  });\n};\n\nAccountsTemplates.postSubmitRedirect = function(route){\n  if (AccountsTemplates.avoidRedirect) {\n    AccountsTemplates.avoidRedirect = false;\n  }\n  else {\n    var nextPath = AccountsTemplates.routes[route] && AccountsTemplates.routes[route].redirect;\n    if (nextPath){\n      if (_.isFunction(nextPath)) {\n        nextPath();\n      }\n      else {\n        Router.go(nextPath);\n      }\n    }else{\n      var previousPath = AccountsTemplates.getPrevPath();\n      if (previousPath && Router.current().route.path() !== previousPath) {\n        Router.go(previousPath);\n      }\n      else{\n        var homeRoutePath = AccountsTemplates.options.homeRoutePath;\n        if (homeRoutePath) {\n          Router.go(homeRoutePath);\n        }\n      }\n    }\n  }\n};\n\nAccountsTemplates.submitCallback = function(error, state, onSuccess){\n\n  var onSubmitHook = AccountsTemplates.options.onSubmitHook;\n  if(onSubmitHook) {\n    onSubmitHook(error, state);\n  }\n\n  if (error) {\n    if(_.isObject(error.details)) {\n      // If error.details is an object, we may try to set fields errors from it\n      _.each(error.details, function(error, fieldId){\n          AccountsTemplates.getField(fieldId).setError(error);\n      });\n    }\n    else {\n      var err = 'error.accounts.Unknown error';\n      if (error.reason) {\n        err = error.reason;\n      }\n      if (err.substring(0, 15) !== 'error.accounts.') {\n        err = 'error.accounts.' + err;\n      }\n      AccountsTemplates.state.form.set('error', [err]);\n    }\n    AccountsTemplates.setDisabled(false);\n    // Possibly resets reCaptcha form\n    if (state === 'signUp' && AccountsTemplates.options.showReCaptcha) {\n      grecaptcha.reset();\n    }\n  }\n  else{\n    if (onSuccess) {\n      onSuccess();\n    }\n\n    if (_.contains(['enrollAccount', 'forgotPwd', 'resetPwd', 'verifyEmail'], state)){\n      var redirectTimeout = AccountsTemplates.options.redirectTimeout;\n      if (redirectTimeout > 0) {\n        AccountsTemplates.timedOutRedirect = Meteor.setTimeout(function(){\n          AccountsTemplates.timedOutRedirect = null;\n          AccountsTemplates.setDisabled(false);\n          AccountsTemplates.postSubmitRedirect(state);\n        }, redirectTimeout);\n      }\n    }\n    else if (state){\n      AccountsTemplates.setDisabled(false);\n      AccountsTemplates.postSubmitRedirect(state);\n    }\n  }\n};\n","/* global\n  AccountsTemplates: false,\n  Router: false\n*/\n'use strict';\n\nAccountsTemplates.atInputRendered = function(){\n  var fieldId = this.data._id;\n  var queryKey = this.data.options && this.data.options.queryKey || fieldId;\n  var currentR = Router.current();\n  var inputQueryVal = currentR && currentR.params && currentR.params.query && currentR.params.query[queryKey];\n  if (inputQueryVal) {\n    this.$(\"input#at-field-\" + fieldId).val(inputQueryVal);\n  }\n\n  var parentData = Template.currentData();\n  var state = (parentData && parentData.state) || AccountsTemplates.getState();\n\n  if (AccountsTemplates.options.focusFirstInput) {\n    var firstVisibleInput = _.find(AccountsTemplates.getFields(), function(f){\n      return _.contains(f.visible, state);\n    });\n\n    if (firstVisibleInput && firstVisibleInput._id === fieldId) {\n      this.$(\"input#at-field-\" + fieldId).focus();\n    }\n  }\n};\n"]}